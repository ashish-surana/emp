<!DOCTYPE HTML>
<html>
    <head>
        <title>Enhanced Meeting Planner</title>
    </head>
    <body>
        <h4><a href='http://ayeshamd.com/emp_insert.html'>to insertion form</a></h4>
        <H1>Enhanced Meeting Planner POC - Search</H1> 
        <hr>
        <fieldset>
            <legend>Enhanced Meeting Planner Elastic Search Server Details</legend>
            EMP Host: <input type="text" id="empHost" value="https://search-emp-cixk22lczi5yrt4zd2dhswnltm.us-east-1.es.amazonaws.com" />
            <br>
            EMP Index: <input type="text" id="empIndex" value="emp" />
            <br>
            EMP Type: <input type="text" id="empType" value="rooms" />
        </fieldset>
        <hr><br>

        <p>
            <button onclick="searchAll()">Search All</button>
            Use this to retrieve all rooms/places

            <br><br>
            <button onclick="searchByEmailId()">Search By Email Id</button>
            <input type="text" id="emailId" value="email" />
        </p>
        <br>
            
        <textarea id="allResponses" rows="20" cols="50">All records </textarea>
        <textarea id="responseByEmailId" rows="20" cols="50">Record matching emailid</textarea>
        <br><hr><br>


        <!-- This script can be moved to emp_core.js -->
        <script>
        var DEV_DEBUG = false;

        function searchAll() {
            var jsonStr = '{"query" : {"match_all" : {}}}';
            if (DEV_DEBUG) alert (jsonStr);

            var empUrl = createElasticSearchUrl();
            //var searchUrl = empUrl + '/_search';
            var searchUrl = createElasticSearchUrl() + '/_search?size=1000&from=0';

            if (DEV_DEBUG) alert (searchUrl);

            var response = searchUsingXmlHttp(searchUrl, jsonStr);
            responseTxt = flattenJson(response);
            //var responseTxt = JSON.stringify(JSON.parse(response),null,2);  
            document.getElementById("allResponses").innerHTML = responseTxt;

        }

        function flattenJson(response) {
            var js = JSON.parse(response);
            var rooms = js.hits.hits;

            var summary = "";
            for (var i = 0; i < rooms.length; i++) {
                summary += 
                    rooms[i]._source.meeting_place.theme + "\t"
                    + rooms[i]._source.meeting_place.email + "\t"
                    + rooms[i]._source.meeting_place.name + "\n"
                    //+ rooms[i]._source.meeting_place.description + "\n"
                ;
            }
            if (DEV_DEBUG) alert (summary);
            return summary;
        }



        function searchByEmailId() {
            var emailId = document.getElementById("emailId").value;
            var jsonStr = '{"query": {"ids" : {"values" : ["' + emailId + '"]}}}';
            if (DEV_DEBUG) alert (jsonStr);

            var searchUrl = createElasticSearchUrl() + '/_search';
            if (DEV_DEBUG) alert (searchUrl);

            var response = searchUsingXmlHttp(searchUrl, jsonStr);
            var responseTxt = JSON.stringify(JSON.parse(response),null,2);  
            document.getElementById("responseByEmailId").innerHTML = responseTxt;           
        }


        function createElasticSearchUrl () {

            var empUrl = null;

            var empHost = document.getElementById("empHost").value;
            var empIndex = document.getElementById("empIndex").value;
            var empType = document.getElementById("empType").value;

            if (empHost == null || empHost == undefined) 
                empHost = 'https://search-emp-cixk22lczi5yrt4zd2dhswnltm.us-east-1.es.amazonaws.com';
            if (empIndex == null || empIndex == undefined)
                empIndex = "emp";
            if (empType == null || empType == undefined) 
                empType = "rooms";
            empUrl = empHost + "/" + empIndex + "/" + empType;
            return empUrl;
        }


        function searchUsingXmlHttp(empUrl, queryStr) {

            //var empUrl = 'https://search-emp-cixk22lczi5yrt4zd2dhswnltm.us-east-1.es.amazonaws.com/emp/rooms/_search?size=1000&from=0'; 

            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open('POST', empUrl, false);
            xmlHttp.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
            xmlHttp.send(queryStr);

            var response = xmlHttp.responseText;  
            if (DEV_DEBUG) alert(response);
            return response;
        }

        </script>
    </body>
</html>