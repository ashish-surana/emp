<!DOCTYPE html>
<html>

<head>
    <title>File Upload and Image Recognition</title>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1.12.min.js"></script>
    <link rel="stylesheet" href="empstyle.css">
</head>


<body>
    <img id="output_image" style="float: top; width: 250px; height: 175px; border: 1px solid #000; margin: 5px" 
            src="https://s3.amazonaws.com/empstorage/placeholder.jpeg"
         />
    <br>

    <input type="file" class="chooseFileButton" id="file-chooser" accept="image/*" onchange="preview_image(event)">
    <br><br>
    <button class="largeButton" id="upload-button" onclick="storeFile()">Upload >></button>
    <br><br>
    <button hidden=true id="image-tags" onclick="getTags()">Get Image Tags >></button>

    <div id="imageTagCheckboxes">
        <!-- to be populated dynamically -->
    </div>

    <div id="selectedTagsDisplay">
        <textarea name="selectedTags" id="selectedTags">Select generated tags or type your own..</textarea>
    </div>

    <p>
    <div>
        Name: <input type="text" id="empName">
        <br>
        Email: <input type="text" id="empEmail"/>
        <br>
        Capacity: <input type="text"  style="width:192px;" id="empCapacity" value="0"/>
        <br>
    </div>
    </p>

    <div>
        <fieldset class="empMultiCheckBoxes" data-role="controlgroup" data-type="horizontal">
            <legend>Choose one or more themes</legend>

            <label for="casual">Casual</label>
            <input type="checkbox" name="theme" class="empTheme" id="casual" value="casual">

            <label for="celebratory">Celebratory</label>
            <input type="checkbox" name="theme" class="empTheme" id="celebratory" value="celebratory">
            
            <label for="cozy">Cozy</label>
            <input type="checkbox" name="theme" class="empTheme" id="cozy" value="cozy">

            <label for="fancy">Fancy</label>
            <input type="checkbox" name="theme" class="empTheme" id="fancy" value="fancy">

            <label for="fun">Fun</label>
            <input type="checkbox" name="theme" class="empTheme" id="fun" value="fun">

            <label for="professional">Professional</label>
            <input type="checkbox" name="theme" class="empTheme" id="professional" value="professional">

            <label for="quiet">Quiet</label>
            <input type="checkbox" name="theme" class="empTheme" id="quiet" value="quiet">

            <label for="studious">Studious</label>
            <input type="checkbox" name="theme" class="empTheme" id="studious" value="studious">

            <label for="zen">Zen</label>
            <input type="checkbox" name="theme" class="empTheme" id="zen" value="zen">
        </fieldset>
    </div>
    <br>
    Description:<br>
    <textarea id="empDescription"></textarea>
    <br>
    <br><br>


    <button class="largeButton" onclick="saveMeetingPlace()">Save meeting place</button>

    <script src="./empstorage_pool.js"></script>
    <script>

        var firstTimeTextAreaDisplay = true;

        var empStorageUrl = "https://s3.amazonaws.com/empstorage/";
        var fileChooser = document.getElementById('file-chooser');
        var button = document.getElementById('upload-button');
        var results = document.getElementById('results');

        function preview_image(event) {
            var reader = new FileReader();
            reader.onload = function() {
                var output = document.getElementById('output_image');
                output.src = reader.result;
            }
            reader.readAsDataURL(event.target.files[0]);
        }

        function storeFile() {
            clearAll();

            var file = fileChooser.files[0];
            store(file);

            getImageTags(file.name);

            document.getElementById("empEmail").value = getRandomEmail();
            //getImageTags
        }

        function getTags() {
            var file = fileChooser.files[0];
            getImageTags(file.name);
        }

        function getImageTags(fileName) {
            
            showDefaultMessage();

            var classificationRequest = '{'
                + '"requests"' + ': ['
                +    '{'
                +        '"image"' + ': {'
                +            '"source"' + ': {'
                +                '"imageUri"' + ':' 
                                    + '"' + empStorageUrl + fileName + '"'
                +            '}'
                +        '},'
                +        '"features"' + ': ['
                +            '{'
                +                '"type"' + ':' + '"LABEL_DETECTION"' + ','
                +                '"maxResults"' + ': 10'
                +            '}'
                +        '],'
                +        '"imageContext"' + ': {}'
                +    '}'
                + ']'
            + '}'
            
            // var url = "https://vision.googleapis.com/v1/images:annotate?key=AIzaSyCpxMZWeEDxIbgu5wkaDv1M_E--eJK8RhY";
            // var xmlHttp = new XMLHttpRequest();
            // xmlHttp.open('POST', url, false);
            // xmlHttp.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
            // xmlHttp.send(classificationRequest);
            // var response = xmlHttp.responseText; 
            var response = sendRequest (classificationRequest);

            //alert ("getImageTags1 :" + response); 
            var tags = parseResponse(response);

            if (tags == "-1") { //try again in one second
                setTimeout(retry(classificationRequest, 4), 1000);
            } else {
                displayTags(tags);
            }
        }


        function retry (classificationRequest, maxTries) {

            if (maxTries <= 0) {
                clearAll();
                showMessage("Problem generating labels - please retry..");
                return;
            }

            showMessage("Retry number: " + maxTries + " - Retrying to generate labels in 1 sec..");
            maxTries = maxTries - 1;

            var response = sendRequest (classificationRequest);
            var tags = parseResponse(response);
            if (tags == "-1") { //try again in one second
                setTimeout(retry(classificationRequest,  maxTries), 1000);
            } else {
                showDefaultMessage();
                displayTags(tags);
            }
        }

        function retry2(classificationRequest) {

            showMessage("Retrying to generate labels in 1 sec..");
            var response = sendRequest (classificationRequest);
            var tags = parseResponse(response);
            if (tags == "-1") { //try again in one second
                setTimeout(retry3(classificationRequest), 2000);
            } else {
                showDefaultMessage();
                displayTags(tags);
            }
        }

        function retry3(classificationRequest) {
            showMessage("Retrying to generate labels in 2 sec..");
            var response = sendRequest (classificationRequest);
            //alert ("getImageTags2 :" + response); 
            var tags = parseResponse(response);
            if (tags == "-1") { 
                clearAll();
                showMessage("Problem generating labels - please retry..");
            } else {
                showDefaultMessage();
                displayTags(tags);
            }
        }

        function sendRequest(requestStr) {
            var url = "https://vision.googleapis.com/v1/images:annotate?key=AIzaSyCpxMZWeEDxIbgu5wkaDv1M_E--eJK8RhY";
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open('POST', url, false);
            xmlHttp.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
            xmlHttp.send(requestStr);
            var response = xmlHttp.responseText; 
            return response;
        }

        //http://freefrontend.com/css-input-text/
        function displayTags(tags) {
            var chbs = '<fieldset class="empMultiCheckBoxes">';
            chbs += '<legend>Generated labels</legend>';
            for (var i = 0; i < tags.length; i++) {
                chbs += 
                '<label for="tag">' + tags[i] + '</label>'
                + '<input type="checkbox" id="tag" onchange="tagSelected()" '
                + 'value="' + tags[i] + '"' 
                + ' />';
            }
            chbs += '</fieldset>';

            document.getElementById("imageTagCheckboxes").innerHTML = chbs;
        }

        /**
        {
            "responses": [
                {
                    "error": {
                        "code": 3,
                        "message": "The URL does not appear to be accessible by us. 
                        Please double check or download the content and pass it in."
                    }
                }
            ]
        }
        */
        function parseResponse (response) {

            var js = JSON.parse(response);
            var response = js.responses[0];
            if (response["error"]) 
                return "-1";

            var tags = new Array();
            var annotations = js.responses[0].labelAnnotations;
             
            for (var i = 0; i < annotations.length; i++) {
                tags.push(annotations[i].description);
                //annotations[i].score;
            }
            return tags;
        }

        function tagSelected() {
            var selectedTagsArray = []
            var checkboxes = document.querySelectorAll('input[type=checkbox]:checked');
            for (var i = 0; i < checkboxes.length; i++) {
                selectedTagsArray.push(checkboxes[i].value)
            }
            document.getElementById("selectedTags").value = selectedTagsArray;
        }   

        function clearAll() {
            document.getElementById("imageTagCheckboxes").innerHTML = "";
            document.getElementById("selectedTags").value = "";
        }

        function showDefaultMessage() {
            showMessage("Select generated tags or type your own..");
        }


        function showMessage(msg) {
            document.getElementById("selectedTags").value = msg;
        }

        function saveMeetingPlace() {
            
            var empEmail = document.getElementById("empEmail").value;
            empEmail = empEmail.trim();
            if ( empEmail == null || empEmail == undefined || empEmail == "") {
                alert ("An email address is required");
                return;
            }
            var empName = document.getElementById("empName").value;
            empName = empName.trim();
            if ( empName == null || empName == undefined || empName == "") {
                alert ("A name for the meeting place is required");
                return;
            }

            var themesArr = new Array(); 
            var inputElements = document.getElementsByClassName('empTheme');
            for(var i=0; inputElements[i]; ++i){
                if(inputElements[i].checked){
                    themesArr.push(inputElements[i].value);
                }
            }
            if (themesArr.length < 1) {
                alert ("A theme for the meeting place is required");
                return;
            }
            var themes = themesArr.join();

            var root = new Object();

            var meeting_place_obj = new Object();
            root.meeting_place = meeting_place_obj;

            var location_obj = new Object();
            var office_location_obj = new Object();
            location_obj.office = office_location_obj;

            var other_location_obj = new Object();
            location_obj.other = other_location_obj;
            root.location = location_obj;
            var tagsObj = new Object();
            root.tags = tagsObj;
            root.meeting_place.email = empEmail;
            root.meeting_place.name = empName;

            root.meeting_place.theme = themes.trim().split(",");
            root.meeting_place.capacity = document.getElementById("empCapacity").value;
            root.meeting_place.description = document.getElementById("empDescription").value;
            var tags = document.getElementById("selectedTags").value;
            root.tags = tags.trim().split(",");
            var jsonStr = JSON.stringify(root);
            alert(jsonStr);
        }

    </script>
</body>

