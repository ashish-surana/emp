<!DOCTYPE html>
<html>

<head>
    <title>AWS S3 File Upload</title>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1.12.min.js"></script>
    <style>
textarea#selectedTags {
	width: 240px;
	height: 50px;
	border: 3px solid #cccccc;
	padding: 5px;
	font-family: Tahoma, sans-serif;
	background-image: url(bg.gif);
	background-position: bottom right;
	background-repeat: no-repeat;
}
    </style>

</head>


<body>
    <img id="output_image" style="float: top; width: 250px; height: 175px; border: 1px solid #000; margin: 5px" 
            src="https://s3.amazonaws.com/empstorage/placeholder.jpeg"
         />
    <br>

    <!-- <div id="wrapper">
            <input type="file" accept="image/*" onchange="preview_image(event)">
            <img id="output_image"/>
    </div> -->

    <!-- <input type="file" id="file-chooser" /> -->
    <input type="file" id="file-chooser" accept="image/*" onchange="preview_image(event)">
    <br>
    <button id="upload-button" onclick="storeFile()">Upload >></button>
    <br>
    <button id="image-tags" onclick="getTags()">Get Image Tags >></button>

    <div id="imageTagCheckboxes">
        <!-- to be populated dynamically -->
    </div>

    <div id="selectedTagsDisplay">
        <textarea name="selectedTags" id="selectedTags">Select generated tags or type your own..</textarea>
    </div>

    <script src="./empstorage_pool.js"></script>
    <script>

        var firstTimeTextAreaDisplay = true;

        var empStorageUrl = "https://s3.amazonaws.com/empstorage/";
        var fileChooser = document.getElementById('file-chooser');
        var button = document.getElementById('upload-button');
        var results = document.getElementById('results');


        function preview_image(event) {
            var reader = new FileReader();
            reader.onload = function() {
                var output = document.getElementById('output_image');
                output.src = reader.result;
            }
            reader.readAsDataURL(event.target.files[0]);
        }

        function storeFile() {
            var file = fileChooser.files[0];
            store(file);
            //getImageTags
        }

        function getTags() {
            var file = fileChooser.files[0];
            getImageTags(file.name);
        }

        function getImageTags(fileName) {
            var classificationRequest = '{'
                + '"requests"' + ': ['
                +    '{'
                +        '"image"' + ': {'
                +            '"source"' + ': {'
                +                '"imageUri"' + ':' 
                                    + '"' + empStorageUrl + fileName + '"'
                +            '}'
                +        '},'
                +        '"features"' + ': ['
                +            '{'
                +                '"type"' + ':' + '"LABEL_DETECTION"' + ','
                +                '"maxResults"' + ': 10'
                +            '}'
                +        '],'
                +        '"imageContext"' + ': {}'
                +    '}'
                + ']'
            + '}'

            alert ("classificationRequest: " + classificationRequest);
            
            var googleUrl = "https://vision.googleapis.com/v1/images:annotate?key=AIzaSyCpxMZWeEDxIbgu5wkaDv1M_E--eJK8RhY";
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open('POST', googleUrl, false);
            xmlHttp.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
            xmlHttp.send(classificationRequest);

            var response = xmlHttp.responseText;  
            var tags = parseResponse(response);
            displayTags(tags);

        }



// {
//   "responses": [
//     {
//       "labelAnnotations": [
//         {
//           "mid": "/m/0215n",
//           "description": "cartoon",
//           "score": 0.9488218,
//           "topicality": 0.9488218
//         },
//         {
//           "mid": "/m/02qd0r",
//           "description": "human behavior",
//           "score": 0.85469866,
//           "topicality": 0.85469866
//         },
//         {
//           "mid": "/m/02h7lkt",
//           "description": "fictional character",
//           "score": 0.83113086,
//           "topicality": 0.83113086
//         },

        function parseResponse (response) {
            alert(response);
            var js = JSON.parse(response);

            var tags = new Array();
            var annotations = js.responses[0].labelAnnotations;
            for (var i = 0; i < annotations.length; i++) {
                tags.push(annotations[i].description);
                //annotations[i].score;
            }
            alert (tags);
            return tags;
        }
        function displayTags(tags) {
            var chbs = "";
            for (var i = 0; i < tags.length; i++) {
                chbs += 
                '<input type="checkbox" id="tag" onchange="tagSelected()" '
                + 'value="' + tags[i] + '"' 
                + ' />'
                + '<label for="tag">' + tags[i] + '</label>';

                // <label for="zen">Zen</label>
                //   <input type="checkbox" name="theme" id="zen" value="zen">
            }
            document.getElementById("imageTagCheckboxes").innerHTML = chbs;
        }

        function tagSelected() {
            var selectedTagsArray = []
            var checkboxes = document.querySelectorAll('input[type=checkbox]:checked');
            for (var i = 0; i < checkboxes.length; i++) {
                selectedTagsArray.push(checkboxes[i].value)
            }

            alert (selectedTagsArray);
            document.getElementById("selectedTags").value = selectedTagsArray;

        }

        function setbg(color)
            {
            document.getElementById("styled").style.background=color
            }
              // var js = JSON.parse(resp);
                // var rooms = js.hits.hits;

                // var summary = "";
                // for (var i = 0; i < rooms.length; i++) {
                //     summary += formatEntry (
                //         rooms[i]._source.meeting_place.theme,
                //         rooms[i]._source.meeting_place.name,
                //         rooms[i]._source.meeting_place.email,
                //         rooms[i]._source.tags,
                //         rooms[i]._source.meeting_place.description
                //     )
                // }


// var array = []
// var checkboxes = document.querySelectorAll('input[type=checkbox]:checked')

// for (var i = 0; i < checkboxes.length; i++) {
//   array.push(checkboxes[i].value)
// }


//'"https://s3.amazonaws.com/empharv/image41.jpeg"'
            //AIzaSyCpxMZWeEDxIbgu5wkaDv1M_E--eJK8RhY
//$ open -a Google\ Chrome --args --disable-web-security --user-data-dir
//https://cloud.google.com/vision/docs/reference/rest/v1p1beta1/images/annotate
            // $.ajax({
            //     type: 'POST',
            //     url: "https://vision.googleapis.com/v1/images:annotate?key=AIzaSyCpxMZWeEDxIbgu5wkaDv1M_E--eJK8RhY",
            //     dataType: 'json',
            //     data: classificationRequest,
            //     //Include headers, otherwise you get an odd 400 error.
            //     headers: {
            //         "Content-Type": "application/json",
            //     },

            //     success: function(data, textStatus, jqXHR) {
            //         alert(data);
            //     },
            //     error: function(jqXHR, textStatus, errorThrown) {
            //         console.log('ERRORS: ' + textStatus + ' ' + errorThrown);
            //     }
            // });


        // $.ajax({
        //     type: 'POST',
        //     url: "https://vision.googleapis.com/v1/images:annotate?key=" + api_key,
        //     dataType: 'json',
        //     data: classificationRequest,
        //     //Include headers, otherwise you get an odd 400 error.
        //     headers: {
        //         "Content-Type": "application/json",
        //     },

        //     success: function(data, textStatus, jqXHR) {
        //         alert(data);
        //     },
        //     error: function(jqXHR, textStatus, errorThrown) {
        //         console.log('ERRORS: ' + textStatus + ' ' + errorThrown);
        //     }
        // });


// {
// 	"requests": [
// 		{
// 			"image": {
// 				"source": {
// 					"imageUri": "https://s3.amazonaws.com/empharv/image41.jpeg"
// 				}
// 			},
// 			"features": [
// 				{
// 					"type": "LABEL_DETECTION",
// 					"maxResults": 10
// 				}
// 			],
// 			"imageContext": {}
// 		}
// 	]
// }

//document.getElementById('files').addEventListener('change', handleFileSelect, false);
//https://stackoverflow.com/questions/14069421/show-an-image-preview-before-upload
    </script>
</body>

